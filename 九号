/*
ğŸ“± ä¹å·æ™ºèƒ½ç”µåŠ¨è½¦ - å•è´¦å·ç­¾åˆ°è„šæœ¬
é€‚ç”¨äº Loon / Surge / Quantumult X

=====================
ğŸ‘¤ ä½œè€…ï¼šâ¥ï¹’ï¹éæˆ‘ä¸å¯
âŒ›ï¸ æ›´æ–°æ—¥æœŸï¼š2015/11/5
ğŸš§ åç»­ç‰ˆæœ¬å°†å¢åŠ æ˜¾ç¤ºâ€œæƒŠå–œç›²ç›’èµšä¸åœâ€ä»»åŠ¡åˆ—è¡¨
ğŸ‘¥Telegram ç¾¤ï¼šhttps://t.me/WorKingCopyAPP
=====================

*/

(async () => {
  // è®¾ç½®å¸¸é‡
  const STORAGE_KEY = 'NINEBOT_ACCOUNT';   // å­˜å‚¨è´¦æˆ·ä¿¡æ¯çš„é”®
  const SIGN_PATH = 'https://cn-cbu-gateway.ninebot.com/portal/api/user-sign/v2/sign';  // ç­¾åˆ°æ¥å£ URL
  const REQUEST_TIMEOUT = 12000;  // è¯·æ±‚è¶…æ—¶æ—¶é—´ (å•ä½ï¼šæ¯«ç§’)
  const MAX_RETRY = 2;  // æœ€å¤§é‡è¯•æ¬¡æ•°

  // ä¹å· mzmax è½¦å‹èƒŒæ™¯å›¾ç‰‡URLï¼ˆå¯ä»¥æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡é“¾æ¥ï¼‰
  const CAR_IMAGE_URL = 'https://example.com/ninebot_mzmax_background.jpg';

  // é€šçŸ¥å‡½æ•°ï¼šå‘é€ç­¾åˆ°æˆåŠŸ/å¤±è´¥é€šçŸ¥
  function notify(title, sub, body, imageUrl) {
    if ($notification && $notification.post) {
      // ä½¿ç”¨èƒŒæ™¯å›¾ç‰‡å‘é€é€šçŸ¥
      $notification.post(title, sub || '', body || '', '', imageUrl || '');
    } else {
      // è‹¥é€šçŸ¥æ— æ³•å‘é€ï¼Œåˆ™åœ¨æ§åˆ¶å°è¾“å‡º
      console.log(`${title}\n${sub || ''}\n${body || ''}`);
    }
  }

  // å®‰å…¨è§£æJSONå­—ç¬¦ä¸²
  function safeParse(s) {
    try {
      return JSON.parse(s);
    } catch (e) {
      return null;
    }
  }

  // æ„å»ºè¯·æ±‚å¤´
  function buildHeaders(acc) {
    return {
      "Host": "cn-cbu-gateway.ninebot.com",
      "Connection": "keep-alive",
      "Content-Type": "application/json",
      "Accept": "application/json, text/plain, */*",
      "Authorization": acc.authorization || '',
      "Sec-Fetch-Site": "same-site",
      "Accept-Language": "zh-CN,zh-Hans;q=0.9",
      "Accept-Encoding": "gzip, deflate, br",
      "platform": "h5",
      "Sec-Fetch-Mode": "cors",
      "Origin": "https://h5-bj.ninebot.com",
      "language": "zh",
      "User-Agent": acc.userAgent || '',
      "Referer": "https://h5-bj.ninebot.com/",
      "device_id": acc.deviceId || '',
      "sys_language": "zh-CN"
    };
  }

  // æ‰§è¡Œ HTTP POST è¯·æ±‚
  function httpPost(opts) {
    return new Promise(resolve => {
      $httpClient.post({...opts, timeout: REQUEST_TIMEOUT}, (err, resp, data) => resolve({ err, resp, data }));
    });
  }

  // è¯»å–å­˜å‚¨ä¸­çš„è´¦æˆ·ä¿¡æ¯
  let raw = $persistentStore.read(STORAGE_KEY) || '';
  let account = null;
  if (raw) {
    try { account = JSON.parse(raw); } catch (e) { account = null; }
  }

  // å¦‚æœæ²¡æœ‰å­˜å‚¨è´¦æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨ç¤ºä¾‹è´¦æˆ·ï¼ˆç”¨æˆ·éœ€è‡ªè¡Œæ›¿æ¢ä¸ºè‡ªå·±çš„ä¿¡æ¯ï¼‰
  if (!account) {
    account = {
      name: 'ä¹å·',  // è®¾å¤‡åç§°
      authorization: 'YOUR_AUTHORIZATION_TOKEN',  // ğŸ‘‰æ›¿æ¢ä¸ºè‡ªå·±çš„Authorization token
      deviceId: 'YOUR_DEVICE_ID',  // ğŸ‘‰æ›¿æ¢ä¸ºè‡ªå·±çš„è®¾å¤‡ID
      userAgent: 'YOUR_USER_AGENT'  // ğŸ‘‰æ›¿æ¢ä¸ºè‡ªå·±çš„User-Agent
    };
  }

  let name = account.name || account.deviceId || 'unknown';  // è®¾å¤‡åç§°
  let headers = buildHeaders(account);  // æ„å»ºè¯·æ±‚å¤´
  let body = JSON.stringify({ deviceId: account.deviceId || '' });  // è¯·æ±‚ä½“

  let attempt = 0;
  let ok = false;
  let lastRaw = '';
  let statusLabel = '';  // ç”¨äºæ˜¾ç¤ºç­¾åˆ°çŠ¶æ€
  let bodyNotify = '';  // é€šçŸ¥å†…å®¹
  let continuous = 0;   // åˆå§‹åŒ–è¿ç»­ç­¾åˆ°å¤©æ•°

  // è¯»å–å­˜å‚¨ä¸­çš„å†å²è¿ç»­ç­¾åˆ°å¤©æ•°
  let storedContinuousDays = parseInt($persistentStore.read("continuous_days") || "0");

  // å¼ºåˆ¶æ£€æŸ¥å­˜å‚¨çš„è¿ç»­ç­¾åˆ°å¤©æ•°
  console.log("è¯»å–å­˜å‚¨çš„è¿ç»­ç­¾åˆ°å¤©æ•°:", storedContinuousDays);

  // å¦‚æœæ²¡æœ‰å­˜å‚¨åˆå§‹å€¼ï¼Œæ‰‹åŠ¨è®¾ç½®ä¸ºä¸€ä¸ªé»˜è®¤å€¼
  if (storedContinuousDays === 0) {
    storedContinuousDays = 401;  // è®¾ç½®ä¸ºæ‰‹åŠ¨ä¿®æ”¹çš„å†å²å¤©æ•°
    let result = $persistentStore.write(storedContinuousDays.toString(), "continuous_days");
    console.log("æ‰‹åŠ¨è®¾ç½®è¿ç»­ç­¾åˆ°å¤©æ•°ä¸º 401ï¼Œå†™å…¥ç»“æœï¼š", result);  // è¾“å‡ºå†™å…¥æ˜¯å¦æˆåŠŸ
  }

  // è¾“å‡ºæ¯æ¬¡è¯·æ±‚çš„ URL å’Œè¯·æ±‚ä½“å†…å®¹
  console.log("è¯·æ±‚ URL:", SIGN_PATH);
  console.log("è¯·æ±‚ä½“:", body);

  // æ‰§è¡Œç­¾åˆ°è¯·æ±‚
  while (attempt <= MAX_RETRY && !ok) {
    attempt++;
    let res = await httpPost({ url: SIGN_PATH, headers, body });
    let err = res.err;
    let data = res.data;
    lastRaw = data ? String(data) : (err ? String(err) : '');

    // è¾“å‡ºå“åº”çŠ¶æ€ç å’ŒåŸå§‹è¿”å›æ•°æ®
    console.log(`ç¬¬ ${attempt} æ¬¡ å“åº”çŠ¶æ€:`, res.resp && res.resp.status);
    console.log(`ç¬¬ ${attempt} æ¬¡ åŸå§‹è¿”å›:`, data);

    if (err) {
      // è‹¥è¯·æ±‚å‡ºé”™ï¼Œç¨ç­‰å†é‡è¯•
      await new Promise(r => setTimeout(r, 600 * attempt));
      continue;
    }

    let parsed = safeParse(data);
    let code = parsed && (parsed.code || parsed.errcode || parsed.status);
    let msg = parsed && (parsed.msg || parsed.message) || '';
    let treatAsSuccess = false;

    if (parsed) {
      // åˆ¤æ–­æ˜¯å¦ä¸ºâ€œå·²ç­¾åˆ°â€çŠ¶æ€
      if (parsed.code === 0 || parsed.errcode === 0 || parsed.success === true || /success/i.test(msg)) treatAsSuccess = true;
      if (parsed.code === 540004 || /å·²ç­¾åˆ°/i.test(msg)) treatAsSuccess = true;
    }

    if (treatAsSuccess) {
      ok = true;
      let payload = parsed.data || parsed.result || parsed.payload || parsed.signInfo || parsed || {};

      // æå–è¿ç»­ç­¾åˆ°å¤©æ•°
      continuous = payload.continuousDays || payload.continuous_day || payload.consecutiveDays || payload.streak || payload.days || payload.continueDay || payload.continuous;
      continuous = continuous || 0;

      // ç´¯åŠ ä¸Šæ¬¡çš„è¿ç»­ç­¾åˆ°å¤©æ•°
      continuous += storedContinuousDays;

      // æ›´æ–°å­˜å‚¨çš„è¿ç»­ç­¾åˆ°å¤©æ•°
      let result = $persistentStore.write(continuous.toString(), "continuous_days");
      console.log("æ›´æ–°è¿ç»­ç­¾åˆ°å¤©æ•°å†™å…¥ç»“æœï¼š", result);  // è¾“å‡ºå†™å…¥æ˜¯å¦æˆåŠŸ
      console.log("å½“å‰è¿ç»­ç­¾åˆ°å¤©æ•°:", continuous);

      // æå–å¥–åŠ±ä¿¡æ¯
      let reward = payload.reward || payload.rewards || payload.points || payload.prize || payload.credit || payload.amount || payload.value;

      // åˆ¤æ–­æ˜¯å¦ä¸ºâ€œå·²ç­¾åˆ°â€çŠ¶æ€
      if (parsed.code === 540004 || /å·²ç­¾åˆ°/i.test(msg)) {
        // å·²ç­¾åˆ°ï¼Œä¸é‡å¤å‘é€é€šçŸ¥
        statusLabel = 'å·²ç­¾åˆ°(ä»Šæ—¥å·²ç­¾)';
        bodyNotify = `${statusLabel}\nå¥–åŠ±ï¼š${reward || 'æ— '}${continuous ? `\nè¿ç»­ç­¾åˆ°ï¼š${continuous} å¤©` : ''}`;
      } else {
        // æ–°ç­¾åˆ°ï¼Œå‘é€é€šçŸ¥
        statusLabel = 'æ–°ç­¾åˆ°(æˆåŠŸ)';
        bodyNotify = `${statusLabel}\nå¥–åŠ±ï¼š${reward || 'æ— '}${continuous ? `\nè¿ç»­ç­¾åˆ°ï¼š${continuous} å¤©` : ''}`;
      }

      // å‘é€é€šçŸ¥ï¼ŒèƒŒæ™¯ä¸ºè½¦å‹å›¾ç‰‡
      notify(`ä¹å·ç­¾åˆ° - ${name}`, statusLabel, bodyNotify, CAR_IMAGE_URL);
      break;
    } else {
      // å‡ºç°é”™è¯¯ï¼Œæ‰“å°é”™è¯¯å¹¶è¿”å›
      if (code === 1) {
        await new Promise(r => setTimeout(r, 800 * attempt));
        continue;
      } else {
        let errorDetails = `ç­¾åˆ°å¤±è´¥ï¼ˆcode:${code || 'æœªçŸ¥'}ï¼‰\næç¤ºï¼š${msg}`;
        notify(`ä¹å·ç­¾åˆ° - ${name}`, 'å¤±è´¥', errorDetails, CAR_IMAGE_URL);
        break;
      }
    }
  }

  // å¦‚æœå¤šæ¬¡å°è¯•ä»ç„¶å¤±è´¥ï¼Œè¾“å‡ºæœ€ç»ˆé”™è¯¯
  if (!ok) {
    let finalError = `å°è¯• ${attempt} æ¬¡ï¼Œè¿”å›ï¼š${lastRaw}\nå»ºè®®ï¼šæ£€æŸ¥ token æ˜¯å¦è¿‡æœŸæˆ–æ›´æ–° Authorizationã€‚`;
    notify(`ä¹å·ç­¾åˆ° - ${name}`, 'å¤±è´¥ï¼ˆæœ€ç»ˆï¼‰', finalError, CAR_IMAGE_URL);
  }

  $done();
})();